name: è®¢é˜…èŠ‚ç‚¹æ›´æ–°

on:
    # å®šæ—¶è§¦å‘
    schedule:
        - cron: '0 */8 * * *' # æ¯8å°æ—¶æ‰§è¡Œä¸€æ¬¡

    # æ‰‹åŠ¨è§¦å‘
    workflow_dispatch:
        inputs:
            reason:
                description: 'è§¦å‘åŸå› '
                required: false
                default: 'æ‰‹åŠ¨è§¦å‘æ›´æ–°'
    workflow_call:
        secrets:
            CONFIG:
                required: true
            SUBSCRIPTION_SYNC_URL:
                required: false

jobs:
    update-nodes:
        runs-on: ubuntu-latest

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: è®¾ç½® Node.js ç¯å¢ƒ
              uses: actions/setup-node@v4
              with:
                  node-version: latest

            - name: è®¾ç½® pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: latest

            - name: å®‰è£…ä¾èµ–
              run: pnpm install --no-frozen-lockfile

            - name: è¿è¡Œæ›´æ–°è„šæœ¬
              run: pnpm run prod
              env:
                  CONFIG: ${{ secrets.CONFIG }}

            - name: æäº¤æ›´æ”¹
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"
                  
                  # æ£€æŸ¥æ˜¯å¦æœ‰æ”¹åŠ¨
                  if [[ -n "$(git status --porcelain)" ]]; then
                    git add .
                    git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹: $(date '+%Y-%m-%d %H:%M:%S')"
                    git push
                  else
                    echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
                  fi

            - name: ç­‰å¾…æäº¤å®Œæˆ
              run: sleep 1

            - name: è§¦å‘åŒæ­¥
              env:
                  SYNC_URL: ${{ secrets.SUBSCRIPTION_SYNC_URL }}
              if: ${{ env.SYNC_URL != '' }}
              run: |
                  if curl -s -o /dev/null -w "%{http_code}" "$SYNC_URL" | grep -q "^2"; then
                      echo "[INFO] åŒæ­¥è§¦å‘æˆåŠŸ"
                  fi
